name: Deploy Backend to AWS Lightsail

on:
  push:
    branches:
      - master
    paths:
      - 'apps/api/**'
      - 'apps/ai-engine/**'
      - 'docker-compose.prod.yml'
      - 'infra/nginx/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to AWS Lightsail
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Lightsail via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e
            echo "========== 배포 시작: $(date) =========="

            # 프로젝트 디렉토리 이동 또는 클론
            if [ -d ~/hanmed-cdss ]; then
              cd ~/hanmed-cdss
              git fetch origin
              git reset --hard origin/master
            else
              git clone https://github.com/lhs0609a-cpu/hanmed-cdss.git ~/hanmed-cdss
              cd ~/hanmed-cdss
            fi

            # 환경 변수 파일 생성
            cat > .env.prod << 'ENVEOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRES_IN=7d
            CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            GPT_MODEL=gpt-4o-mini
            TOSS_CLIENT_KEY=${{ secrets.TOSS_CLIENT_KEY }}
            TOSS_SECRET_KEY=${{ secrets.TOSS_SECRET_KEY }}
            ENVEOF

            # 기존 서비스 강제 중지 및 정리
            echo "========== 기존 컨테이너 정리 =========="

            # 1. 모든 실행 중인 컨테이너 중지
            sudo docker stop $(sudo docker ps -q) 2>/dev/null || true

            # 2. 모든 컨테이너 강제 제거 (실행 중 + 중지된 것 모두)
            sudo docker rm -f $(sudo docker ps -a -q) 2>/dev/null || true

            # 3. 모든 Docker 네트워크 정리 (기본 네트워크 제외)
            sudo docker network prune -f 2>/dev/null || true

            # 4. Docker 시스템 전체 정리
            sudo docker system prune -af 2>/dev/null || true

            # 5. Docker 데몬 재시작으로 포트 바인딩 완전 해제
            sudo systemctl restart docker
            sleep 5

            # 6. 포트 사용 현황 확인
            echo "========== 포트 사용 현황 =========="
            sudo netstat -tlnp | grep -E ':(3001|8080|80|443) ' || echo "사용 중인 포트 없음"

            echo "========== 컨테이너 정리 완료 =========="

            # SSL 인증서 확인 및 발급 (없는 경우에만)
            if [ ! -f /etc/letsencrypt/live/api.ongojisin.co.kr/fullchain.pem ]; then
              echo "========== SSL 인증서 발급 =========="
              sudo apt-get update
              sudo apt-get install -y certbot
              sudo mkdir -p /var/www/certbot

              # 80번 포트 해제 확인
              sudo fuser -k 80/tcp || true

              # 인증서 발급 (standalone 모드)
              sudo certbot certonly --standalone \
                -d api.ongojisin.co.kr \
                --non-interactive \
                --agree-tos \
                --email lhs0609c@naver.com \
                || echo "인증서 발급 실패"
            else
              echo "========== SSL 인증서 존재함 =========="
            fi

            # SSL 인증서 존재 여부에 따라 nginx 설정 선택
            if [ -f /etc/letsencrypt/live/api.ongojisin.co.kr/fullchain.pem ]; then
              echo "========== HTTPS 모드로 시작 =========="
              cp infra/nginx/nginx.conf infra/nginx/nginx-active.conf
            else
              echo "========== HTTP 모드로 시작 (SSL 인증서 없음) =========="
              cp infra/nginx/nginx-http.conf infra/nginx/nginx-active.conf
            fi

            # Docker Compose로 서비스 시작
            sudo docker-compose -f docker-compose.prod.yml --env-file .env.prod pull || true
            sudo docker-compose -f docker-compose.prod.yml --env-file .env.prod build --no-cache
            sudo docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d

            # 헬스 체크
            sleep 15
            echo "========== 서비스 상태 =========="
            sudo docker-compose -f docker-compose.prod.yml ps

            # API 헬스 체크
            curl -sf http://localhost:3001/api/v1/health || echo "API 헬스체크 실패 (정상 작동 중일 수 있음)"
            curl -sf http://localhost:8080/health || echo "AI Engine 헬스체크 실패 (정상 작동 중일 수 있음)"
            curl -sf https://api.ongojisin.co.kr/api/v1/health || echo "HTTPS 헬스체크 실패 (정상 작동 중일 수 있음)"

            echo "========== 배포 완료: $(date) =========="

      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ 배포 성공!"
          else
            echo "❌ 배포 실패!"
          fi
