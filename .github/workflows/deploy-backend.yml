name: Deploy Backend to AWS Lightsail

on:
  push:
    branches:
      - master
    paths:
      - 'apps/api/**'
      - 'apps/ai-engine/**'
      - 'docker-compose.prod.yml'
      - 'infra/nginx/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to AWS Lightsail
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Lightsail via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e
            echo "========== 배포 시작: $(date) =========="

            # 프로젝트 디렉토리 이동 또는 클론
            if [ -d ~/hanmed-cdss ]; then
              cd ~/hanmed-cdss
              git fetch origin
              git reset --hard origin/master
            else
              git clone https://github.com/lhs0609a-cpu/hanmed-cdss.git ~/hanmed-cdss
              cd ~/hanmed-cdss
            fi

            # 환경 변수 파일 생성
            cat > .env.prod << 'ENVEOF'
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRES_IN=7d
            CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            GPT_MODEL=gpt-4o-mini
            TOSS_CLIENT_KEY=${{ secrets.TOSS_CLIENT_KEY }}
            TOSS_SECRET_KEY=${{ secrets.TOSS_SECRET_KEY }}
            ENVEOF

            # 기존 서비스 강제 중지 및 정리
            echo "========== 기존 컨테이너 정리 =========="

            # 모든 hanmed 관련 컨테이너 강제 종료 및 제거
            sudo docker ps -a --filter "name=hanmed" -q | xargs -r sudo docker rm -f || true

            # docker-compose down 시도
            sudo docker-compose -f docker-compose.prod.yml --env-file .env.prod down --remove-orphans --volumes 2>/dev/null || true

            # 포트를 사용하는 모든 프로세스 강제 종료 (fuser 사용)
            sudo fuser -k 3001/tcp 2>/dev/null || true
            sudo fuser -k 8080/tcp 2>/dev/null || true
            sudo fuser -k 80/tcp 2>/dev/null || true
            sudo fuser -k 443/tcp 2>/dev/null || true

            # 잠시 대기 후 다시 확인
            sleep 3

            # 포트 사용 중인 Docker 컨테이너 모두 종료
            for port in 3001 8080 80 443; do
              CONTAINER=$(sudo docker ps -q --filter "publish=$port")
              if [ -n "$CONTAINER" ]; then
                echo "포트 $port 사용 중인 컨테이너 종료: $CONTAINER"
                sudo docker rm -f $CONTAINER || true
              fi
            done

            # 사용하지 않는 Docker 리소스 정리
            sudo docker network prune -f 2>/dev/null || true
            sudo docker system prune -f 2>/dev/null || true

            echo "========== 컨테이너 정리 완료 =========="

            # SSL 인증서 확인 및 발급 (없는 경우에만)
            if [ ! -f /etc/letsencrypt/live/api.ongojisin.co.kr/fullchain.pem ]; then
              echo "========== SSL 인증서 발급 =========="
              sudo apt-get update
              sudo apt-get install -y certbot
              sudo mkdir -p /var/www/certbot

              # 80번 포트 해제 확인
              sudo fuser -k 80/tcp || true

              # 인증서 발급 (standalone 모드)
              sudo certbot certonly --standalone \
                -d api.ongojisin.co.kr \
                --non-interactive \
                --agree-tos \
                --email lhs0609c@naver.com \
                || echo "인증서 발급 실패"
            else
              echo "========== SSL 인증서 존재함 =========="
            fi

            # SSL 인증서 존재 여부에 따라 nginx 설정 선택
            if [ -f /etc/letsencrypt/live/api.ongojisin.co.kr/fullchain.pem ]; then
              echo "========== HTTPS 모드로 시작 =========="
              cp infra/nginx/nginx.conf infra/nginx/nginx-active.conf
            else
              echo "========== HTTP 모드로 시작 (SSL 인증서 없음) =========="
              cp infra/nginx/nginx-http.conf infra/nginx/nginx-active.conf
            fi

            # Docker Compose로 서비스 시작
            sudo docker-compose -f docker-compose.prod.yml --env-file .env.prod pull || true
            sudo docker-compose -f docker-compose.prod.yml --env-file .env.prod build --no-cache
            sudo docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d

            # 헬스 체크
            sleep 15
            echo "========== 서비스 상태 =========="
            sudo docker-compose -f docker-compose.prod.yml ps

            # API 헬스 체크
            curl -sf http://localhost:3001/api/v1/health || echo "API 헬스체크 실패 (정상 작동 중일 수 있음)"
            curl -sf http://localhost:8080/health || echo "AI Engine 헬스체크 실패 (정상 작동 중일 수 있음)"
            curl -sf https://api.ongojisin.co.kr/api/v1/health || echo "HTTPS 헬스체크 실패 (정상 작동 중일 수 있음)"

            echo "========== 배포 완료: $(date) =========="

      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ 배포 성공!"
          else
            echo "❌ 배포 실패!"
          fi
